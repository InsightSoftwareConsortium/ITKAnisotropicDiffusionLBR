<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Anisotropic Diffusion LBR</title>
    <style>
      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      textarea.emscripten { font-family: monospace; width: 80%; }
    </style>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="bootstrap.min.js"></script>
  </head>
<body>
  <div class="container">
    <h1>Anisotropic Diffusion LBR</h1>
    <div class="row">
      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">Input image</div>
          <div class="panel-body">PacMan.png</div>
        </div>
        <img src="PacMan.png" class="img-responsive center-block" alt="Input image" id="input-image">
      </div>
      <div class="col-sm-6">
        <div class="panel panel-success">
          <div class="panel-heading">Output image</div>
          <div class="panel-body">PacMan.png</div>
        </div>
        <img src="PacMan.png" class="img-responsive center-block"
             alt="Output image" id="output-image" style="visibility:hidden;">
      </div>
    </div>
    <hr/>
    <textarea class="emscripten" id="output" rows="16"></textarea>
    <hr/>
  </div>

  <script type="text/javascript">
    var Module = {
      preRun: [],
      postRun: [],
      print: (function() {
        var element = document.getElementById('output');
        if (element) element.value = ''; // clear browser cache
        return function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          // These replacements are necessary if you render to raw HTML
          //text = text.replace(/&/g, "&amp;");
          //text = text.replace(/</g, "&lt;");
          //text = text.replace(/>/g, "&gt;");
          //text = text.replace('\n', '<br>', 'g');
          console.log(text);
          if (element) {
            element.value += text + "\n";
            element.scrollTop = element.scrollHeight; // focus on bottom
          }
        };
      })(),
      printErr: function(text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        if (0) { // XXX disabled for safety typeof dump == 'function') {
          dump(text + '\n'); // fast, straight to the real console
        } else {
          console.error(text);
        }
      },
      noInitialRun: true,
      arguments: ['/Input/PacMan.png', '/PacManFiltered.png',
                  '20', '0.05', 'cCED', '3']
    };
  </script>
  <script src="CoherenceEnhancingDiffusion.js" async></script>
  <script type="text/javascript">
    var inputImage = document.getElementById("input-image");
    var outputImage = document.getElementById("output-image");
    function run_main() {
      args = ['/Input/PacMan.png', '/Filtered.png',
              '20', '0.05', 'cEED', '3'];
      Module.callMain(args);
      outputBits = FS.readFile('/Filtered.png', { encoding: 'binary' });
      try {
        var blob = new Blob([outputBits], {"type": "image\/png"});
        window.URL = window.URL || window.webkitURL;
        outputImage.src = window.URL.createObjectURL(blob);
      } catch (err) { // in case blob / URL missing, fallback to data-uri
        var rawString = '';
        for(var i = 0; i < outputBits.length; ++i) {
          rawString += String.fromCharCode(outputBits[i]);
        }
        outputImage.src = 'data:image\/png;base64,' + btoa(rawString);
      }
      outputImage.style.visibility = 'visible';
    };
    $( window ).load( run_main );
  </script>
</body>
</html>
